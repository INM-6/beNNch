<?xml version="1.0" encoding="UTF-8"?>
<jube>

  <!-- MAM -->

  <include-path>
    <path>../jube_config/</path>
  </include-path>


  <benchmark name="MAM" outpath="../../../BenchWork/jube_MAM/nest_2.20.1/jusuf_jureca">

    <parameterset name="global">
	    <parameter name="base_path" type="string">/p/project/cjinb33/albers2/ACA_bm_framework</parameter>
      <parameter name="account" type="string">jinb33</parameter>
      <parameter name="email_address" type="string"></parameter>
      <parameter name="run_file" type="string">
        ${bench_model}/multi-area-model/run_benchmark.py
      </parameter>
      <parameter name="modules">nest-simulator/2.20.1-timers-jusuf_jureca</parameter>
      <parameter name="PARTITION">dc-cpu</parameter>
      <parameter name="STDOUT_PATH">$jube_wp_abspath</parameter>
    </parameterset>

    <parameterset name="scale_check">
      <parameter name="base_vp" type="int">64</parameter>
      <parameter name="base_scale" type="float">1.</parameter>
      <parameter name="model_time_sim" type="float">10000.</parameter>
      <parameter name="model_time_presim" type="float">500.</parameter>
      <parameter name="WALLTIME" type="string">02:00:00</parameter>
      <parameter name="num_nodes" type="int">12</parameter>
      <parameter name="num_vps" type="int" mode="python">$base_vp*$num_nodes</parameter>
      <parameter name="SCALE" type="float" mode="python">1.</parameter>
      <parameter name="K_SCALE" type="float" mode="python">1.</parameter>
      <!-- <parameter name="num_omp_threads" type="int">32</parameter> -->
      <parameter name="num_omp_threads" type="int">4</parameter>
      <parameter name="NEST_VERSION">2</parameter>
      <parameter name="MAM_STATE">Fig5</parameter>  <!-- Fig3: Groundstate, Fig5: Metastable, see Schmidt et al. 2018 -->
      <parameter name="MASTER_SEED">2,3,4</parameter>
    </parameterset>

    <step name="bench">
      <use>global</use>
      <use from="dir_config.xml">dir_config</use>
      <use from="bench_jobs.xml">slurm,run_benchmark,files,sub_bench_job</use>
      <use>scale_check</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>


    <!-- Analyse -->
    <analyser name="analyse_scale_check">
      <use from="bench_jobs.xml">nest_pattern_MAM_timer</use>      <!-- use existing patternset -->
      <analyse step="bench">
        <file>timer_data.txt</file>        <!-- file which should be scanned -->
      </analyse>
    </analyser>

    <!-- Create result table -->
    <result>
      <use>analyse_scale_check</use>      <!-- use existing analyser -->
      <table name="NEST_MAM" style="csv" sort="number">
        <column>num_nodes</column>
        <column>threads_per_node</column>
        <column>tasks_per_node</column>
        <column>MASTER_SEED</column>
        <column>model_time_sim</column>
        <column>model_time_presim</column>
        <column>wall_time_create</column>
        <column>wall_time_connect</column>
        <column>wall_time_sim</column>
        <column>wall_time_phase_collocate</column>
        <column>wall_time_phase_communicate</column>
        <column>wall_time_phase_deliver</column>
        <column>wall_time_phase_update</column>
        <column>wall_time_communicate_target_data</column>
        <column>wall_time_gather_spike_data</column>
        <column>wall_time_gather_target_data</column>
        <column>wall_time_communicate_prepare</column>
        <column>py_time_kernel_prepare</column>
        <column>py_time_network_local</column>
        <column>py_time_network_global</column>
        <column>py_time_simulate</column>
        <column>py_time_presimulate</column>
        <column>py_time_network_prepare</column>
        <column>py_time_create</column>
        <column>py_time_connect</column>
        <column>base_memory</column>
        <column>network_memory</column>
        <column>init_memory</column>
        <column>total_memory</column>
        <column>num_connections</column>
        <column>local_spike_counter</column>
      </table>
    </result>


  </benchmark>
</jube>
